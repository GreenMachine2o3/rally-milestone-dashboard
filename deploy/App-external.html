<!DOCTYPE html>
<html>
<head>
    <title>Milestone Progress Dashboard</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Milestone Progress Dashboard",{extend:"Rally.app.App",componentCls:"app",store:void 0,userStoryStore:void 0,milestoneStore:void 0,grid:void 0,milestoneComboBox:void 0,pointsRemaining:[],refinedPercentage:[],selectedIter:void 0,milestones:[],targetDates:[],milestonesUsed:[],milestoneNumber:void 0,grids:[],gridsMade:0,header:void 0,container:void 0,milestonesRemaining:void 0,featuresByMilestone:[],totalRefinedPercent:[],totalProgressPercent:[],projects:[],projectHasPreState:[],refinedProgressBar:void 0,listeners:{resize:function(){this.container&&this.window&&(this.container.setWidth(this.window.innerWidth),this.grids.forEach(function(e){e.setWidth(this.window.innerWidth)}))},afterRender:function(){this.container=Ext.create("Ext.panel.Panel"),this.setLoading(!0,!1)}},launch:function(){this.header=Ext.create("Ext.panel.Header",{title:"Milestone Progress",titleAlign:"center",height:40,style:"font-size: 1.6em;"}),this.refinedProgressBar=Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate",{percentDoneName:"PointsRemainingRefined"}),this.refinedProgressBar.setCalculateColorFn(function(e){var t=e[this.percentDoneName];return 0===(t=Math.round(100*t))?"#E0E0E0":t<=33?"#F66349":t<=66?"#FAD200":100!==t?"#8DC63F":"#D1D1D1"}),this.getProjects()},getProjects:function(){var e=new XMLHttpRequest;e.open("GET","https://rally1.rallydev.com/slm/webservice/v2.0/project/"),e.setRequestHeader("Content-type","application/json");var t=this;e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){t.projects=JSON.parse(e.responseText).QueryResult.Results;for(var a=0;a<t.projects.length;a++)t.getProjectScheduleState(t.projects[a])}},e.send()},getProjectScheduleState:function(e){e._ref=e._ref.substring(e._ref.indexOf("/project"),e._ref.length),Rally.data.ModelFactory.getModel({type:"UserStory",context:{project:e._ref,projectScopeUp:!1,projectScopeDown:!1},success:function(t){t.getField("ScheduleState").getAllowedValueStore().load({callback:function(t,a,s){"Defined"===t[0].get("StringValue")?this.projectHasPreState[e._ref]=[!1]:this.projectHasPreState[e._ref]=[!0],Object.keys(this.projectHasPreState).length===this.projects.length&&this._loadReleases()},scope:this})},scope:this})},_loadReleases:function(){Ext.create("Rally.data.wsapi.Store",{model:"Milestone",limit:1/0,autoLoad:!0,listeners:{load:function(e,t){this.milestoneNumber=t.length-1;for(var a=0;a<t.length;a++)if(0===this.milestones.length)this.milestones.push(t[a].data.Name),this.targetDates.push(t[a].data.TargetDate);else for(var s=0;s<this.milestones.length&&this.milestones[s]!==t[a].data.Name;s++)s===this.milestones.length-1&&(this.milestones.push(t[a].data.Name),this.targetDates.push(t[a].data.TargetDate));this.sortMilestones(this.milestones,this.targetDates)},scope:this}})},getMonthNumber:function(e){return"Jan"===e?1:"Feb"===e?2:"Mar"===e?3:"Apr"===e?4:"May"===e?5:"Jun"===e?6:"Jul"===e?7:"Aug"===e?8:"Sep"===e?9:"Oct"===e?10:"Nov"===e?11:"Dec"===e?12:0},isGreater:function(e,t){if(e&&!t)return!0;if(e){var a=e.toString().split(" "),s=t.toString().split(" ");return a[3]>s[3]||!(a[3]<s[3])&&(this.getMonthNumber(a[1])>this.getMonthNumber(s[1])||!(this.getMonthNumber(a[1])<this.getMonthNumber(s[1]))&&(a[2]>s[2]||(a[2],s[2],!1)))}return!1},sortMilestones:function(e,t){for(var a=0;a<e.length-1;a++)for(var s=0;s<e.length-a-1;s++)if(this.isGreater(t[s],t[s+1])){var r=e[s],i=t[s];e[s]=e[s+1],t[s]=t[s+1],e[s+1]=r,t[s+1]=i}this.getFeatures()},getFeatures:function(){Ext.create("Rally.data.wsapi.Store",{model:"portfolioitem/feature",context:{projectScopeUp:!1},listeners:{load:function(e,t){for(var a=0,s=0;s<t.length;s++)if(0===t[s].data.Milestones.Count)this.featuresByMilestone[1e6]?this.featuresByMilestone[1e6].push(t[s]):(this.milestonesUsed[1e6]=null,a++,this.featuresByMilestone[1e6]=[t[s]]);else for(var r=0;r<t[s].data.Milestones._tagsNameArray.length;r++)for(var i=0;i<this.milestones.length;i++)t[s].data.Milestones._tagsNameArray[r].Name===this.milestones[i]&&(this.featuresByMilestone[i]?this.featuresByMilestone[i].push(t[s]):(this.milestonesUsed[i]=this.milestones[i],a++,this.featuresByMilestone[i]=[t[s]]));var n=[];this.milestonesUsed.forEach(function(e){n.push(e)}),this.milestonesUsed=n;var o=[];this.featuresByMilestone.forEach(function(e){o.push(e)}),this.featuresByMilestone=o,this.getUserStoryData(e,this.featuresByMilestone,a)},scope:this},autoLoad:!0,fetch:["FormattedID","Name","PercentDoneByStoryPlanEstimate","RefinedEstimate","LeafStoryPlanEstimateTotal","Project","Release","Milestones"]})},getUserStoryData:function(e,t,a){this.pointsRemaining=[];Ext.create("Rally.data.wsapi.Store",{model:"User Story",limit:1/0,context:{workspace:this.getContext().getWorkspaceRef(),project:null},fetch:["Feature","PlanEstimate","ScheduleState","Parent"],listeners:{load:function(s,r){if(r)for(var i=!1,n=0;n<t.length;n++){for(var o=0,l=0,d=0,h=0;h<t[n].length;h++){var c=0,u=0,m=0,f=0;i=!this.projectHasPreState[t[n][h].data.Project._ref]||this.projectHasPreState[t[n][h].data.Project._ref][0];for(var p=0;p<r.length;p++)if(null!==r[p].data.Feature&&r[p].data.Feature._ref===t[n][h].data._ref){u+=r[p].data.PlanEstimate;var g=r[p].data.ScheduleState;"Accepted"!==g?r[p].data.Parent&&r[p].data.Parent._ref!==t[n][h].data._ref||(c+=r[p].data.PlanEstimate):f+=r[p].data.PlanEstimate,i?"Defined"!==g&&"In-Progress"!==g&&"Completed"!==g&&"Accepted"!==g||(m+=r[p].data.PlanEstimate):"In-Progress"!==g&&"Completed"!==g&&"Accepted"!==g||(m+=r[p].data.PlanEstimate)}o+=u,l+=m,d+=f,this.refinedPercentage[h]=0!==u?m/u:0,this.pointsRemaining[h]=c}var P=l/o,y=d/o;isNaN(P)&&(P=0),isNaN(y)&&(y=0),this.totalRefinedPercent[n]=P,this.totalProgressPercent[n]=y,this._onStoreBuilt(e,t[n],this.milestonesUsed[n],n,a)}},scope:this},autoLoad:!0,scope:this})},getColumnCfgs:function(e){var t="%"+Math.round(100*this.totalRefinedPercent[e]).toString(),a="%"+Math.round(100*this.totalProgressPercent[e]).toString();return[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),flex:.5,summaryRenderer:function(){return"Totals"}},{dataIndex:"Name",text:"Feature Name",flex:1.5},{xtype:"templatecolumn",dataIndex:"PercentDoneByStoryPlanEstimate",text:"Feature Progress",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate"),flex:.7,summaryRenderer:function(){return a}},{xtype:"templatecolumn",dataIndex:"PointsRemainingRefined",text:"Refined %",tpl:this.refinedProgressBar,flex:.7,summaryRenderer:function(){return t}},{dataIndex:"RefinedEstimate",text:"Refined Estimate",flex:1,summaryType:"sum"},{dataIndex:"LeafStoryPlanEstimateTotal",text:"Total Leaf Plan Estimate",flex:1,summaryType:"sum"},{dataIndex:"PointsRemaining",text:"Points Remaining",flex:1,summaryType:"sum"},{dataIndex:"ProjectName",text:"Project",flex:1.5},{dataIndex:"ReleaseName",text:"Release",flex:1.5}]},_onStoreBuilt:function(e,t,a,s,r){null===a&&(a="No Milestone");var i=this.pointsRemaining,n=this.refinedPercentage,o=-1,l=_.map(t,function(e){return o++,Ext.apply({PointsRemaining:i[o],ReleaseName:e.data.Release?e.data.Release.Name:"",PointsRemainingRefined:n[o],ProjectName:e.data.Project?e.data.Project.Name:""},e.getData())}),d=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",title:a,titleAlign:"center",hideCollapseTool:!0,collapsible:!0,collapsed:!0,editable:!1,showPagingToolbar:!1,titleCollapse:!0,store:Ext.create("Rally.data.custom.Store",{data:l,pageSize:1e11,groupField:void 0}),features:[{ftype:"summary"}],columnCfgs:this.getColumnCfgs(s),showRowActionsColumn:!1});this.grids[s]=d,this.gridsMade++,this.gridsMade===r&&this.addComponents()},addComponents:function(){this.container.add(this.header);var e=[];this.grids.forEach(function(t){e.push(t)});for(var t=0;t<e.length;t++)this.container.add(e[t]);this.add(this.container),this.setLoading(!1,!1)}});

            Rally.launchApp('Milestone Progress Dashboard', {
                name:"Milestone Progress Dashboard",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .x-header{background-color:royalblue}.x-header-text{font-weight:600;font-size:1.3em}.x-collapsed{height:2.5em !important}.x-panel-header{height:4em !important;background-color:lightblue;border-style:solid;border-width:1px !important;border-right:0;border-left:0;cursor:pointer}.x-panel-header:hover{background-color:cornflowerblue}.x-box-inner{margin:auto}.x-panel-body-default{border-color:black;border-width:3px}.x-grid-cell-inner{padding:4px 2px}.x-grid-row-summary *{font-weight:700;font-size:1.25em}.x-grid-table{table-layout:unset}
    </style>
</head>
<body>
</body>
</html>
