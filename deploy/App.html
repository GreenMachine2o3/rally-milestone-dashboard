<!DOCTYPE html>
<html>
<head>
    <title>Milestone Progress Dashboard</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Milestone Progress Dashboard",{extend:"Rally.app.App",componentCls:"app",store:void 0,userStoryStore:void 0,milestoneStore:void 0,grid:void 0,milestoneComboBox:void 0,pointsRemaining:[],refinedPercentage:[],selectedIter:void 0,milestones:[],milestonesUsed:[],milestoneNumber:void 0,grids:[],gridsMade:0,header:void 0,container:void 0,milestonesRemaining:void 0,featuresByMilestone:[],totalRefinedPercent:[],totalProgressPercent:[],projects:[],projectHasPreState:[],refinedProgressBar:void 0,listeners:{resize:function(){this.container&&this.window&&(this.container.setWidth(this.window.innerWidth),this.grids.forEach(function(e){e.setWidth(this.window.innerWidth)}))},afterRender:function(){this.container=Ext.create("Ext.panel.Panel"),this.setLoading(!0,!1)}},launch:function(){this.header=Ext.create("Ext.panel.Header",{title:"Milestone Progress",titleAlign:"center",height:40,style:"font-size: 1.6em;"}),this.refinedProgressBar=Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate",{percentDoneName:"PointsRemainingRefined"}),this.refinedProgressBar.setCalculateColorFn(function(e){var t=e[this.percentDoneName];return 0===(t=Math.round(100*t))?"#E0E0E0":t<=33?"#F66349":t<=66?"#FAD200":100!==t?"#8DC63F":"#D1D1D1"}),this.getProjects()},getProjects:function(){var e=new XMLHttpRequest;e.open("GET","https://rally1.rallydev.com/slm/webservice/v2.0/project/"),e.setRequestHeader("Content-type","application/json");var t=this;e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){t.projects=JSON.parse(e.responseText).QueryResult.Results;for(var a=0;a<t.projects.length;a++)t.getProjectScheduleState(t.projects[a])}},e.send()},getProjectScheduleState:function(e){e._ref=e._ref.substring(e._ref.indexOf("/project"),e._ref.length),Rally.data.ModelFactory.getModel({type:"UserStory",context:{project:e._ref,projectScopeUp:!1,projectScopeDown:!1},success:function(t){t.getField("ScheduleState").getAllowedValueStore().load({callback:function(t,a,s){"Defined"===t[0].get("StringValue")?this.projectHasPreState[e._ref]=[!1]:this.projectHasPreState[e._ref]=[!0],Object.keys(this.projectHasPreState).length===this.projects.length&&this._loadReleases()},scope:this})},scope:this})},_loadReleases:function(){Ext.create("Rally.data.wsapi.Store",{model:"Milestone",limit:1/0,autoLoad:!0,listeners:{load:function(e,t){this.milestoneNumber=t.length-1;for(var a=0;a<t.length;a++)if(0===this.milestones.length)this.milestones.push(t[a].data.Name);else for(var s=0;s<this.milestones.length&&this.milestones[s]!==t[a].data.Name;s++)s===this.milestones.length-1&&this.milestones.push(t[a].data.Name);this.getFeatures()},scope:this}})},getFeatures:function(){Ext.create("Rally.data.wsapi.Store",{model:"portfolioitem/feature",context:{projectScopeUp:!1},listeners:{load:function(e,t){for(var a=0,s=0;s<t.length;s++)if(0===t[s].data.Milestones.Count)this.featuresByMilestone[1e6]?this.featuresByMilestone[1e6].push(t[s]):(this.milestonesUsed[1e6]=null,a++,this.featuresByMilestone[1e6]=[t[s]]);else for(var i=0;i<t[s].data.Milestones._tagsNameArray.length;i++)for(var n=0;n<this.milestones.length;n++)t[s].data.Milestones._tagsNameArray[i].Name===this.milestones[n]&&(this.featuresByMilestone[n]?this.featuresByMilestone[n].push(t[s]):(this.milestonesUsed[n]=this.milestones[n],a++,this.featuresByMilestone[n]=[t[s]]));var r=[];this.milestonesUsed.forEach(function(e){r.push(e)}),this.milestonesUsed=r;var o=[];this.featuresByMilestone.forEach(function(e){o.push(e)}),this.featuresByMilestone=o,this.getUserStoryData(e,this.featuresByMilestone,a)},scope:this},autoLoad:!0,fetch:["FormattedID","Name","PercentDoneByStoryPlanEstimate","RefinedEstimate","LeafStoryPlanEstimateTotal","Project","Release","Milestones"]})},getUserStoryData:function(e,t,a){this.pointsRemaining=[];Ext.create("Rally.data.wsapi.Store",{model:"User Story",limit:1/0,context:{workspace:this.getContext().getWorkspaceRef(),project:null},fetch:["Feature","PlanEstimate","ScheduleState","Parent"],listeners:{load:function(s,i){if(i)for(var n=!1,r=0;r<t.length;r++){for(var o=0,l=0,d=0,c=0;c<t[r].length;c++){var h=0,m=0,u=0,f=0;n=!this.projectHasPreState[t[r][c].data.Project._ref]||this.projectHasPreState[t[r][c].data.Project._ref][0];for(var p=0;p<i.length;p++)if(null!==i[p].data.Feature&&i[p].data.Feature._ref===t[r][c].data._ref){m+=i[p].data.PlanEstimate;var g=i[p].data.ScheduleState;"Accepted"!==g?i[p].data.Parent&&i[p].data.Parent._ref!==t[r][c].data._ref||(h+=i[p].data.PlanEstimate):f+=i[p].data.PlanEstimate,n?"Defined"!==g&&"In-Progress"!==g&&"Completed"!==g&&"Accepted"!==g||(u+=i[p].data.PlanEstimate):"In-Progress"!==g&&"Completed"!==g&&"Accepted"!==g||(u+=i[p].data.PlanEstimate)}o+=m,l+=u,d+=f,this.refinedPercentage[c]=0!==m?u/m:0,this.pointsRemaining[c]=h}var P=l/o,y=d/o;isNaN(P)&&(P=0),isNaN(y)&&(y=0),this.totalRefinedPercent[r]=P,this.totalProgressPercent[r]=y,this._onStoreBuilt(e,t[r],this.milestonesUsed[r],r,a)}},scope:this},autoLoad:!0,scope:this})},getColumnCfgs:function(e){var t="%"+Math.round(100*this.totalRefinedPercent[e]).toString(),a="%"+Math.round(100*this.totalProgressPercent[e]).toString();return[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),flex:.5,summaryRenderer:function(){return"Totals"}},{dataIndex:"Name",text:"Feature Name",flex:1.5},{xtype:"templatecolumn",dataIndex:"PercentDoneByStoryPlanEstimate",text:"Feature Progress",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate"),flex:.7,summaryRenderer:function(){return a}},{xtype:"templatecolumn",dataIndex:"PointsRemainingRefined",text:"Refined %",tpl:this.refinedProgressBar,flex:.7,summaryRenderer:function(){return t}},{dataIndex:"RefinedEstimate",text:"Refined Estimate",flex:1,summaryType:"sum"},{dataIndex:"LeafStoryPlanEstimateTotal",text:"Total Leaf Plan Estimate",flex:1,summaryType:"sum"},{dataIndex:"PointsRemaining",text:"Points Remaining",flex:1,summaryType:"sum"},{dataIndex:"ProjectName",text:"Project",flex:1.5},{dataIndex:"ReleaseName",text:"Release",flex:1.5}]},_onStoreBuilt:function(e,t,a,s,i){null===a&&(a="No Milestone");var n=this.pointsRemaining,r=this.refinedPercentage,o=-1,l=_.map(t,function(e){return o++,Ext.apply({PointsRemaining:n[o],ReleaseName:e.data.Release?e.data.Release.Name:"",PointsRemainingRefined:r[o],ProjectName:e.data.Project?e.data.Project.Name:""},e.getData())}),d=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",title:a,titleAlign:"center",hideCollapseTool:!0,collapsible:!0,collapsed:!0,editable:!1,showPagingToolbar:!1,titleCollapse:!0,store:Ext.create("Rally.data.custom.Store",{data:l,pageSize:1e11,groupField:void 0}),features:[{ftype:"summary"}],columnCfgs:this.getColumnCfgs(s),showRowActionsColumn:!1});this.grids[s]=d,this.gridsMade++,this.gridsMade===i&&this.addComponents()},addComponents:function(){this.container.add(this.header);var e=[];this.grids.forEach(function(t){e.push(t)});for(var t=0;t<e.length;t++)this.container.add(e[t]);this.add(this.container),this.setLoading(!1,!1)}});

            Rally.launchApp('Milestone Progress Dashboard', {
                name:"Milestone Progress Dashboard",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .x-header{background-color:royalblue}.x-header-text{font-weight:600;font-size:1.3em}.x-collapsed{height:2.5em !important}.x-panel-header{height:4em !important;background-color:lightblue;border-style:solid;border-width:1px !important;border-right:0;border-left:0;cursor:pointer}.x-panel-header:hover{background-color:cornflowerblue}.x-box-inner{margin:auto}.x-panel-body-default{border-color:black;border-width:3px}.x-grid-cell-inner{padding:4px 2px}.x-grid-row-summary *{font-weight:700;font-size:1.25em}.x-grid-table{table-layout:unset}
    </style>
</head>
<body>
</body>
</html>
